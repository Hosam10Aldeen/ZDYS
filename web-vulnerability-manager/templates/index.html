<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Web Zafiyet Değerlendirme Sistemi</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .container { max-width: 800px; margin: auto; padding: 20px; }
        h1, h2, h3 { color: #333; }
        form { margin-bottom: 30px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        label { display: block; margin-top: 10px; }
        input[type="text"], input[type="email"], input[type="number"], input[type="password"] { width: 100%; padding: 6px; margin-top: 4px; }
        .checkbox-group label { display: inline-block; margin-right: 10px; }
        button { margin-top: 10px; padding: 8px 12px; border: none; background-color: #3498db; color: white; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #2980b9; }
        .flash { padding: 10px; margin-bottom: 20px; border-radius: 4px; }
        .flash-success { background-color: #2ecc71; color: white; }
        .flash-error { background-color: #e74c3c; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
        th { background-color: #f2f2f2; }
        .enabled { color: green; font-weight: bold; }
        .disabled { color: red; font-weight: bold; }
        .action-form { display: inline; }
        .navbar { margin-bottom: 20px; }
        .navbar a { margin-right: 10px; color: #3498db; text-decoration: none; }
         .result-block { border: 1px solid #ddd; padding: 10px; margin-top: 10px; border-radius: 4px; }
        .result-block h3 { margin: 0 0 5px 0; }
        .error { color: red; }
        .success { color: green; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Web Zafiyet Tarama Sistemi</h1>
        <div class="navbar">
            Hoşgeldin, {{ username }} |
            <a href="{{ url_for('logout') }}">Çıkış Yap</a> |
            <a href="{{ url_for('download_last_pdf') }}">Son Raporu İndir</a> |
            <a href="{{ url_for('download_pdf') }}">Tüm Raporları İndir</a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, msg in messages %}
              <div class="flash flash-{{ category }}">{{ msg }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <h2>Anlık Tarama Başlat</h2>
<form id="scan-form">
    <label for="url">Hedef URL veya IP:</label>
    <input type="text" id="url" name="url" placeholder="ör: example.com veya https://example.com" required>

    <label>Tarama Araçları:</label>
    <div class="checkbox-group">
        <label><input type="checkbox" name="tools" value="nmap"> Nmap</label>
        <label><input type="checkbox" name="tools" value="nikto"> Nikto</label>
        <label><input type="checkbox" name="tools" value="wpscan"> WPScan</label>
        <label><input type="checkbox" name="tools" value="zap"> OWASP ZAP</label>
    </div>

    <label for="email">E-posta ile gönder (opsiyonel):</label>
    <input type="email" id="email" name="email" placeholder="ornek@site.com">

    <button type="submit">Taramayı Başlat</button>
</form>


        <div id="results">
            <!-- Burada her aracın sonucu anlık görünecek -->
        </div>

        <h2>Zamanlanmış Tarama Oluştur</h2>
        <form method="POST" action="{{ url_for('index') }}">
            <input type="hidden" name="action" value="create_schedule">
            <label for="sched_target">Hedef URL veya IP:</label>
            <input type="text" id="sched_target" name="sched_target" placeholder="http://örnek.com" required>

            <label>Tarama Araçları:</label>
            <div class="checkbox-group">
                <label><input type="checkbox" name="sched_tools" value="nmap"> Nmap</label>
                <label><input type="checkbox" name="sched_tools" value="nikto"> Nikto</label>
                <label><input type="checkbox" name="sched_tools" value="wpscan"> WPScan</label>
                <label><input type="checkbox" name="sched_tools" value="zap"> OWASP ZAP</label>
            </div>

            <label for="sched_email">E-posta ile gönder:</label>
            <input type="email" id="sched_email" name="sched_email" placeholder="ornek@site.com" required>

            <label for="sched_interval">Tekrar aralığı (dakika):</label>
            <input type="number" id="sched_interval" name="sched_interval" min="1" placeholder="Örn. 60" required>

            <button type="submit">Zamanlanmış Tarama Ekle</button>
        </form>

        <h2>Mevcut Zamanlanmış Taramalar</h2>
        {% if schedules %}
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Hedef</th>
                        <th>Araçlar</th>
                        <th>E-posta</th>
                        <th>Interval (dk)</th>
                        <th>Durum</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sched in schedules %}
                        <tr>
                            <td>{{ sched.id }}</td>
                            <td>{{ sched.target }}</td>
                            <td>{{ sched.tools | join(', ') }}</td>
                            <td>{{ sched.email or '-' }}</td>
                            <td>{{ sched.interval_minutes }}</td>
                            <td>
                                {% if sched.enabled %}
                                    <span class="enabled">Aktif</span>
                                {% else %}
                                    <span class="disabled">Pasif</span>
                                {% endif %}
                            </td>
                            <td>
                                <form method="POST" action="{{ url_for('toggle_schedule', sid=sched.id) }}" class="action-form">
                                    <button type="submit">{{ 'Pasif Yap' if sched.enabled else 'Aktif Yap' }}</button>
                                </form>
                                <form method="POST" action="{{ url_for('delete_schedule', sid=sched.id) }}" class="action-form" onsubmit="return confirm('Schedule id={{sched.id}} silinsin mi?');">
                                    <button type="submit">Sil</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Henüz zamanlanmış tarama tanımı yok.</p>
        {% endif %}
    </div>
    <!-- ... -->
<div id="results"></div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('scan-form');
    const resultsDiv = document.getElementById('results');

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        resultsDiv.innerHTML = '';

        const url = document.getElementById('url').value.trim();
        const email = document.getElementById('email').value.trim();
        const checkboxes = document.querySelectorAll('input[name="tools"]:checked');
        const tools = Array.from(checkboxes).map(cb => cb.value);
        if (!url) {
            alert("Lütfen hedef URL girin.");
            return;
        }
        if (tools.length === 0) {
            alert("Lütfen en az bir tarama aracı seçin.");
            return;
        }

        // Aynı scan_id ile gruplamak istersen:
        const scanId = Math.floor(Date.now() / 1000);

        const scanPromises = tools.map(tool => {
            const block = document.createElement('div');
            block.className = 'result-block';
            block.id = 'result-' + tool;
            // Başlangıçta "Çalışıyor..." gösterebiliriz:
            const title = document.createElement('h3');
            title.textContent = tool.toUpperCase();
            block.appendChild(title);
            const p = document.createElement('p');
            p.textContent = 'Çalışıyor...';
            block.appendChild(p);
            resultsDiv.appendChild(block);

            // AJAX isteği
            return fetch('{{ url_for("scan_tool") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ tool: tool, target: url, scan_id: scanId })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(errData.error || `HTTP ${response.status}`);
                    }).catch(() => {
                        throw new Error(`HTTP status ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                const block = document.getElementById('result-' + tool);
                block.innerHTML = '';  // önce içeriği temizle
                const title = document.createElement('h3');
                title.textContent = tool.toUpperCase();
                block.appendChild(title);

                if (data.error) {
                    const p = document.createElement('p');
                    p.className = 'error';
                    p.textContent = `Hata: ${data.error}`;
                    block.appendChild(p);
                } else {
                    // CVSS
                    const pCvss = document.createElement('p');
                    pCvss.innerHTML = `CVSS Skoru: <strong>${data.cvss}</strong>`;
                    block.appendChild(pCvss);

                    if (tool === 'zap') {
                        const alerts = data.alerts || [];
                        if (alerts.length > 0) {
                            const ul = document.createElement('ul');
                            alerts.forEach(alert => {
                                const li = document.createElement('li');
                                const name = alert.name || '';
                                const risk = alert.risk || '';
                                li.textContent = `${name} (Risk: ${risk})`;
                                ul.appendChild(li);
                            });
                            block.appendChild(ul);
                        } else {
                            const pNo = document.createElement('p');
                            pNo.textContent = 'Uyarı bulunamadı.';
                            block.appendChild(pNo);
                        }
                    } else {
                        // Diğer araç çıktısı: ham metni <pre> ile göster
                        const pre = document.createElement('pre');
                        // Ham textContent olarak ata, böylece tüm newline ve özel karakterler korunur
                        pre.textContent = data.output || '';
                        block.appendChild(pre);
                    }
                }
                return data;
            })
            .catch(err => {
                const block = document.getElementById('result-' + tool);
                block.innerHTML = '';
                const title = document.createElement('h3');
                title.textContent = tool.toUpperCase();
                block.appendChild(title);
                const p = document.createElement('p');
                p.className = 'error';
                p.textContent = `İstek hatası: ${err.message}`;
                block.appendChild(p);
                // Hata objesini de return: e-posta gönderim için
                return { tool: tool, error: err.message, cvss: 0.0 };
            });
        });

        Promise.all(scanPromises).then(results => {
            if (email) {
                fetch('{{ url_for("send_email") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ email: email, results: results })
                })
                .then(resp => resp.json())
                .then(data => {
                    const info = document.createElement('p');
                    if (data.status === 'ok') {
                        info.className = 'success';
                        info.textContent = `E-posta gönderildi: ${email}`;
                    } else {
                        info.className = 'error';
                        info.textContent = `E-posta gönderilemedi: ${data.error || JSON.stringify(data)}`;
                    }
                    resultsDiv.appendChild(info);
                })
                .catch(err => {
                    const info = document.createElement('p');
                    info.className = 'error';
                    info.textContent = `E-posta isteği hatası: ${err.message}`;
                    resultsDiv.appendChild(info);
                });
            }
        });
    });
});
</script>

</body>
</html>
