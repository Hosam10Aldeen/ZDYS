# mailer.py
import os
import smtplib
from email.mime.text import MIMEText

def send_report_email(to_email, results):
    # SMTP konfigürasyonunu env değişkenlerinden al
    SMTP_HOST = os.environ.get('SMTP_HOST')
    SMTP_PORT = int(os.environ.get('SMTP_PORT', 587))
    SMTP_USER = os.environ.get('SMTP_USER')
    SMTP_PASS = os.environ.get('SMTP_PASS')
    FROM_EMAIL = os.environ.get('FROM_EMAIL', SMTP_USER)
    print("SMTP_HOST:", SMTP_HOST, "SMTP_USER:", SMTP_USER)

    if not SMTP_HOST or not SMTP_USER or not SMTP_PASS:
        # Konfig eksikse hata fırlat veya logla
        raise RuntimeError("SMTP ayarları eksik: SMTP_HOST, SMTP_USER veya SMTP_PASS ortam değişkenleri tanımlı değil.")

    # E-posta içeriği
    body = "Tarama sonuçları:\n\n"
    for res in results:
        # ZAP için alerts varsa JSON listesi içinde name/risk/...
        if res.get('alerts') is not None:
            body += f"Araç: {res['tool']}\nCVSS Skoru: {res['cvss']}\n"
            alerts = res.get('alerts', [])
            if alerts:
                for alert in alerts:
                    # Örneğin sadece adı ve riski ekle, çok uzun olmasın:
                    name = alert.get('name', '')
                    risk = alert.get('risk', '')
                    body += f"  - Alert: {name} (Risk: {risk})\n"
            else:
                body += "  - Uyarı bulunamadı.\n"
            body += "\n"
        else:
            # Diğer araçlar
            output = res.get('output') or ''
            body += f"Araç: {res['tool']}\nCVSS Skoru: {res['cvss']}\nÇıktı:\n{output}\n\n"

    msg = MIMEText(body)
    msg['Subject'] = os.environ.get('EMAIL_SUBJECT', 'Tarama Raporu')
    msg['From'] = FROM_EMAIL
    msg['To'] = to_email

    # Gönder
    try:
        with smtplib.SMTP(SMTP_HOST, SMTP_PORT) as server:
            server.ehlo()
            if SMTP_PORT == 587:
                server.starttls()
                server.ehlo()
            server.login(SMTP_USER, SMTP_PASS)
            server.send_message(msg)
    except Exception as e:
        # Hata durumunu logla veya raise et
        print(f"E-posta gönderme hatası: {e}")
        # Dilersen:
        # raise
    print("SMTP_HOST:", SMTP_HOST, "SMTP_USER:", SMTP_USER)

# Örnek kullanımda, uygulamayı başlatmadan önce:
# export SMTP_HOST=smtp.gmail.com
# export SMTP_PORT=587
# export SMTP_USER=webzdys@gmail.com
# export SMTP_PASS=ZDYS.123
# export FROM_EMAIL=webzdys@gmail.com
# export EMAIL_SUBJECT="Zafiyet Taraması Raporu"
