# app.py
import time
import sqlite3
import json
from flask import Flask, render_template, request, redirect, url_for, session, send_file, flash
from scanner_api_client import run_scan
from database_manager import init_db, save_scan_result, get_user_all_results, get_user_last_scan_results, DB_PATH
from report_generator import generate_pdf
from utils import normalize_output, calculate_cvss, calculate_cvss_from_alerts, level_class
from auth import login_required, login_user, logout_user
from database_manager import create_user, get_user_by_id
from mailer import send_report_email
import os

app = Flask(__name__)
app.secret_key = os.environ.get('FLASK_SECRET_KEY', 'super_secret_key')
app.jinja_env.globals.update(level_class=level_class)

# Veritabanı tabloları oluştur
init_db()

# Kullanıcı kayıt route
@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        username = request.form.get('username').strip()
        password = request.form.get('password')
        password2 = request.form.get('password2')
        if not username or not password or not password2:
            flash("Lütfen tüm alanları doldurun.", "error")
            return render_template('register.html')
        if password != password2:
            flash("Şifreler uyuşmuyor.", "error")
            return render_template('register.html')
        # Yeni kullanıcı oluştur
        user_id = create_user(username, password)
        if not user_id:
            flash("Bu kullanıcı adı zaten alınmış.", "error")
            return render_template('register.html')
        flash("Kayıt başarılı. Lütfen giriş yapın.", "success")
        return redirect(url_for('login'))
    return render_template('register.html')

# Giriş route
@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form.get('username').strip()
        password = request.form.get('password')
        if login_user(username, password):
            flash(f"Hoşgeldin, {username}.", "success")
            return redirect(url_for('index'))
        else:
            flash("Geçersiz kullanıcı adı veya şifre.", "error")
    return render_template('login.html')

# Logout
@app.route('/logout')
def logout():
    logout_user()
    flash("Çıkış yapıldı.", "success")
    return redirect(url_for('login'))

# Helper: schedules işlemleri kullanıcı bazlı
def get_schedules_for_user(user_id):
    """
    Kullanıcının tüm schedule kayıtlarını getirir.
    Dönüş: list of dict: {'id', 'target', 'tools' (list), 'email', 'interval_minutes', 'enabled'}
    """
    schedules = []
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    try:
        c.execute("SELECT id, target, tools, email, interval_minutes, enabled FROM schedules WHERE user_id = ? ORDER BY id ASC", (user_id,))
        rows = c.fetchall()
    except sqlite3.OperationalError:
        conn.close()
        return schedules
    conn.close()
    for row in rows:
        sid, target, tools_json, email, interval, enabled = row
        try:
            tools = json.loads(tools_json)
            if not isinstance(tools, list):
                tools = []
        except Exception:
            tools = []
        schedules.append({
            'id': sid,
            'target': target,
            'tools': tools,
            'email': email,
            'interval_minutes': interval,
            'enabled': bool(enabled)
        })
    return schedules

def create_schedule_entry(user_id, target, tools_list, email, interval_minutes):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute(
        "INSERT INTO schedules (target, tools, email, interval_minutes, enabled, user_id) VALUES (?, ?, ?, ?, 1, ?)",
        (target, json.dumps(tools_list), email, interval_minutes, user_id)
    )
    conn.commit()
    conn.close()

def delete_schedule_entry(user_id, sid):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    # Sadece kendi kullanıcısının kaydı silinebilsin:
    c.execute("DELETE FROM schedules WHERE id = ? AND user_id = ?", (sid, user_id))
    conn.commit()
    conn.close()

def toggle_schedule_entry(user_id, sid):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    # Sadece kendi kullanıcısının kaydı güncellenir:
    c.execute("SELECT enabled FROM schedules WHERE id = ? AND user_id = ?", (sid, user_id))
    row = c.fetchone()
    if row:
        current = row[0]
        new = 0 if current == 1 else 1
        c.execute("UPDATE schedules SET enabled = ? WHERE id = ? AND user_id = ?", (new, sid, user_id))
    conn.commit()
    conn.close()

# Anasayfa: anlık tarama ve schedule yönetimi
@app.route('/', methods=['GET', 'POST'])
@login_required
def index():
    user_id = session.get('user_id')
    username = session.get('username')
    if request.method == 'POST':
        action = request.form.get('action')
        if action == 'scan_now':
            url = request.form.get('url')
            selected_tools = request.form.getlist('tools')
            email = request.form.get('email') or None
            if not url or not selected_tools:
                flash("Lütfen URL girin ve en az bir araç seçin.", "error")
                return redirect(url_for('index'))
            scan_id = int(time.time())
            results = []
            for tool in selected_tools:
                result = run_scan(tool, url)
                if result.get('error'):
                    results.append({"tool": tool, "output": None, "alerts": [], "cvss": 0.0, "error": result.get('error')})
                    # Hata kaydı da sakla
                    save_scan_result(scan_id, url, tool, output=None, alerts_json=None, cvss=0.0, user_id=user_id)
                    continue
                if tool.lower() == 'zap':
                    alerts = result.get('alerts', [])
                    cvss = calculate_cvss_from_alerts(alerts)
                    save_scan_result(scan_id, url, 'zap', output=None, alerts_json=json.dumps(alerts, ensure_ascii=False), cvss=cvss, user_id=user_id)
                    results.append({"tool": "zap", "alerts": alerts, "cvss": cvss})
                else:
                    out = normalize_output(result.get('output'))
                    cvss = calculate_cvss(out)
                    save_scan_result(scan_id, url, tool, output=out, alerts_json=None, cvss=cvss, user_id=user_id)
                    results.append({"tool": tool, "output": out, "cvss": cvss})
            if email:
                try:
                    send_report_email(email, results)
                    flash(f"Tarama tamamlandı ve e-posta gönderildi: {email}", "success")
                except Exception as e:
                    flash(f"Tarama sonucu kaydedildi, ancak e-posta gönderilemedi: {e}", "error")
            return render_template('report.html', results=results, username=username)
        elif action == 'create_schedule':
            target = request.form.get('sched_target')
            tools = request.form.getlist('sched_tools')
            email = request.form.get('sched_email') or None
            interval = request.form.get('sched_interval')
            if not target or not tools or not interval:
                flash("Lütfen hedef URL, interval ve en az bir araç seçin.", "error")
                return redirect(url_for('index'))
            try:
                interval = int(interval)
                if interval <= 0:
                    raise ValueError
            except:
                flash("Interval pozitif tam sayı olmalı.", "error")
                return redirect(url_for('index'))
            create_schedule_entry(user_id, target, tools, email, interval)
            flash(f"Yeni zamanlanmış tarama eklendi: {target}, araçlar={tools}, interval={interval} dk.", "success")
            return redirect(url_for('index'))
        else:
            flash("Bilinmeyen işlem.", "error")
            return redirect(url_for('index'))

    # GET: verileri hazırla
    schedules = get_schedules_for_user(user_id)
    # Kullanıcının geçmiş taramaları listesi isteğe bağlı index'te gösterilebilir
    return render_template('index.html', schedules=schedules, username=username)

# Schedule silme
@app.route('/schedule/delete/<int:sid>', methods=['POST'])
@login_required
def delete_schedule(sid):
    user_id = session.get('user_id')
    delete_schedule_entry(user_id, sid)
    flash(f"Schedule id={sid} silindi.", "success")
    return redirect(url_for('index'))

# Schedule toggle
@app.route('/schedule/toggle/<int:sid>', methods=['POST'])
@login_required
def toggle_schedule(sid):
    user_id = session.get('user_id')
    toggle_schedule_entry(user_id, sid)
    flash(f"Schedule id={sid} etkinlik durumu değiştirildi.", "success")
    return redirect(url_for('index'))

# PDF indirme: sadece kullanıcının kendi sonuçları
@app.route('/rapor/pdf')
@login_required
def download_pdf():
    user_id = session.get('user_id')
    results = get_user_all_results(user_id)
    try:
        filepath = generate_pdf(results)
    except Exception as e:
        return f"PDF oluşturulamadı: {e}", 500
    return send_file(filepath, as_attachment=True)

@app.route('/rapor/pdf/last')
@login_required
def download_last_pdf():
    user_id = session.get('user_id')
    results = get_user_last_scan_results(user_id)
    try:
        filepath = generate_pdf(results)
    except Exception as e:
        return f"PDF oluşturulamadı: {e}", 500
    return send_file(filepath, as_attachment=True)

@app.route('/rapor/list')
@login_required
def list_reports():
    user_id = session.get('user_id')
    results = get_user_all_results(user_id)
    return render_template('report_list.html', results=results, username=session.get('username'))

if __name__ == '__main__':
    app.run(debug=True)
